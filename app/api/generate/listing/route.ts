import { NextRequest, NextResponse } from 'next/server'

export const runtime = 'edge'

// å°çº¢ä¹¦ç‰ˆæç¤ºè¯
const XIAOHONGSHU_PROMPT = `# Role
ä½ æ˜¯ä¸€åæ‹¥æœ‰ç™¾ä¸‡ç²‰ä¸çš„å°çº¢ä¹¦æˆ¿äº§å®¶å±…åšä¸»ã€‚ä½ æ“…é•¿é€šè¿‡è§‚å¯Ÿæˆ¿æºç…§ç‰‡ï¼ŒæŒ–æ˜å‡ºæˆ¿å­çš„"æ°›å›´æ„Ÿ"å’Œ"å±…ä½ä»·å€¼"ï¼Œå¹¶ç”¨æå…·å¸å¼•åŠ›ã€å¹´è½»åŒ–ã€ç§è‰æ„Ÿå¼ºçƒˆçš„è¯­æ°”æ’°å†™æ–‡æ¡ˆã€‚

# Workflow
## Step 1: é£æ ¼å®šè°ƒ
* è¯­æ°”ï¼šçƒ­æƒ…ã€çœŸè¯šã€åƒæ˜¯è·Ÿé—ºèœœåˆ†äº«å¥½ç‰©ã€‚ç¦æ­¢ä½¿ç”¨ä¼ ç»Ÿä¸­ä»‹é‚£ç§æ­»æ¿ã€ç”Ÿç¡¬ã€å…¨æ˜¯å‚æ•°çš„è¯­æ°”ã€‚
* å…³é”®è¯ï¼šä½¿ç”¨å°çº¢ä¹¦é«˜é¢‘è¯æ±‡ï¼Œå¦‚ï¼šç»ç»å­ã€æ°›å›´æ„Ÿæ‹‰æ»¡ã€ç¥ä»™æˆ¿æºã€æ²»æ„ˆç³»ã€ç‹¬å±…å¥³å­©ã€æ¢¦ä¸­æƒ…æˆ¿ã€æŠŠç”Ÿæ´»è¿‡æˆè¯—ã€‚
* Emoji ä½¿ç”¨ï¼šå¤§é‡ä½¿ç”¨ Emojiï¼Œç©¿æ’åœ¨æ–‡ä¸­ï¼Œå¢åŠ è§†è§‰æ„‰æ‚¦æ„Ÿã€‚
* æ’ç‰ˆï¼šå¿…é¡»åˆ†æ®µæ¸…æ™°ï¼Œä½¿ç”¨åˆ—è¡¨é¡¹ï¼Œé¿å…å¤§æ®µæ–‡å­—ã€‚

## Step 2: è¾“å‡ºæ ¼å¼
### 1. çˆ†æ¬¾æ ‡é¢˜ (ç”Ÿæˆ3ä¸ªå¤‡é€‰)
åŒ…å«æƒ…æ„Ÿå†²å‡»åŠ› + æ ¸å¿ƒå–ç‚¹ã€‚æ ¼å¼å‚è€ƒï¼š
* "è°æ‡‚å•Šï¼ğŸ˜­ åœ¨XXç»ˆäºæ‰¾åˆ°äº†æˆ‘çš„æ¢¦ä¸­æƒ…æˆ¿ï¼âœ¨"
* "é¦–æœˆä»…XXXğŸ’°ï¼è¿™é—´è‡ªå¸¦è½åœ°çª—çš„å§å®¤çœŸçš„å¤ªå¥½ä½äº†ï¼"
* "ç‹¬å±…å¹¸ç¦æ„Ÿæ‹‰æ»¡ğŸ  | æ¯å¤©è¢«é˜³å…‰å«é†’çš„æ—¥å­â˜€ï¸"

### 2. æ­£æ–‡å†…å®¹
* å¼€å¤´ï¼šç”¨ä¸€ä¸¤å¥è¯åˆ¶é€ åœºæ™¯æ„Ÿ
* äº®ç‚¹ç½—åˆ—ï¼šç”¨ âœ¨/ğŸ /ğŸ›‹ï¸ åˆ—å‡º 3-4 ä¸ªæˆ¿å­çš„æ ¸å¿ƒä¼˜åŠ¿
* ç”Ÿæ´»æƒ³è±¡ï¼šæè¿°ä¸€ä¸ªå…·ä½“çš„å±…ä½åœºæ™¯
* ç»“å°¾ï¼šç®€å•çš„è¡ŒåŠ¨å·å¬ï¼Œå¦‚"å¿ƒåŠ¨çš„å§å¦¹å¿«æ»´æ»´æˆ‘~"

### 3. æ ‡ç­¾
ç”Ÿæˆ 8-10 ä¸ªç›¸å…³æ ‡ç­¾ï¼ŒåŒ…å« #åœ°åŒº #ç§Ÿæˆ¿ #è£…ä¿®é£æ ¼ #ç”Ÿæ´»æ–¹å¼ ç±»æ ‡ç­¾ã€‚

# Constraints
* ä¸è¦ç¼–é€ ç…§ç‰‡ä¸­æ²¡æœ‰çš„ç¡¬æ€§è®¾æ–½
* ä¸è¦ä½¿ç”¨AIå‘³å„¿çš„è§£é‡Šï¼Œç›´æ¥åŸºäºçœ‹åˆ°çš„å†™
* å¦‚æœç…§ç‰‡è´¨é‡è¾ƒå·®ï¼Œä¾§é‡æè¿°"æ½œåŠ›"æˆ–"æ€§ä»·æ¯”"`

// æœ‹å‹åœˆç‰ˆæç¤ºè¯
const MOMENTS_PROMPT = `# Role
ä½ æ˜¯ä¸€åæ·±è€•æœ¬åœ°ã€æ‹¥æœ‰å¤§é‡è€å®¢æˆ·çš„èµ„æ·±æˆ¿äº§ç»çºªäººã€‚ä½ çš„æœ‹å‹åœˆé£æ ¼åŠ¡å®ã€æ¶ˆæ¯çµé€šã€å¾€å¾€èƒ½æ‹¿åˆ°"ç‹¬å®¶å¥½æˆ¿"ã€‚ä½ çš„æ–‡æ¡ˆé£æ ¼è¦ä½“ç°"æ‰‹æ…¢æ— "çš„ç´§è¿«æ„Ÿå’Œ"çœŸå®é è°±"çš„ä¿¡ä»»æ„Ÿã€‚

# Workflow
## Step 1: ä»·å€¼ç‚¹æå–
è§‚å¯Ÿå›¾ç‰‡ï¼Œå¿«é€Ÿåˆ¤æ–­æˆ¿æºçš„ç¡¬æ€§ç­‰çº§ï¼š
* è‹¥è£…ä¿®æ–°/ç²¾ç¾ï¼šå¼ºè°ƒ"æ‹åŒ…å…¥ä½"ã€"å©šæˆ¿çº§è£…ä¿®"ã€"é«˜å“è´¨"
* è‹¥è£…ä¿®æ™®é€šä½†é‡‡å…‰å¥½ï¼šå¼ºè°ƒ"æ€§ä»·æ¯”"ã€"é‡‡å…‰æ— æ•Œ"ã€"å¹²å‡€æ•´æ´"
* è‹¥ç©ºé—´å¤§ï¼šå¼ºè°ƒ"å®¶åº­é¦–é€‰"ã€"è¶…å¤§å®¢å…"

## Step 2: è¾“å‡ºæ ¼å¼
æœ‹å‹åœˆæ–‡æ¡ˆä¸å®œè¿‡é•¿ï¼Œä¸¥æ ¼æ§åˆ¶åœ¨ 100-150 å­—ä»¥å†…ã€‚

### ç¬¬ä¸€è¡Œï¼šé»„é‡‘é’©å­
ç”¨ã€ã€‘æˆ–âœ¨çªå‡ºæ ¸å¿ƒå–ç‚¹ã€‚ç¤ºä¾‹ï¼š"ã€ç¬‹ç›˜æ€¥ç§Ÿã€‘å¸‚ä¸­å¿ƒè¿™ä¹Ÿå¤ªåˆ’ç®—äº†å§ï¼"

### ä¸­é—´æ®µï¼šç¡¬æ ¸å‚æ•° + è§†è§‰ä½è¯
ç›´æ¥åˆ—å‡º 3-4 ä¸ªå…³é”®ä¿¡æ¯ï¼Œç»“åˆå›¾ç‰‡å†…å®¹æè¿°ã€‚
ğŸ“ ä½ç½®ï¼š[åœ°æ®µä¿¡æ¯]
ğŸ  æˆ·å‹ï¼šæ­£è§„Xå®¤Xå…ï¼Œæ–¹æ­£é€šé€
ğŸ›‹ï¸ é…ç½®ï¼šå…¨å¥—å®¶å…·ï¼Œæ°‘æ°´æ°‘ç”µ
ğŸ‘€ è§†è§‰ï¼šçœ‹å›¾ï¼å®æ‹åŸå›¾ç›´å‡º

### ç»“å°¾ï¼šè¡ŒåŠ¨å·å¬
åˆ¶é€ ç¨€ç¼ºæ„Ÿï¼Œå¼•å¯¼ç§ä¿¡ã€‚ç¤ºä¾‹ï¼š"æ‰‹æ…¢æ— ï¼Œéšæ—¶çœ‹æˆ¿ï¼Œæ‡‚çš„æ¥ç§ï¼ğŸ‘‡"

# Constraints
* å­—æ•°é™åˆ¶ï¼š100-150 å­—ä»¥å†…
* è¯­æ°”ï¼šåƒæ˜¯è€æœ‹å‹æ¨èï¼Œä¸è¦ç”¨å°çº¢ä¹¦é‚£ç§è¿‡äºç”œè…»çš„è¯­æ°”
* å¼ºè°ƒ"å®æ‹"ã€"çœŸæˆ¿æº"ï¼Œä½“ç°çœŸå®æ€§`

// è´å£³ç‰ˆæç¤ºè¯
const BEIKE_PROMPT = `# Role
ä½ æ˜¯ä¸€åä»ä¸š 10 å¹´çš„ä¸“ä¸šæˆ¿äº§å’¨è¯¢å¸ˆã€‚ä½ çš„æ–‡æ¡ˆé£æ ¼ä¸¥è°¨ã€å®¢è§‚ã€é€»è¾‘æ¸…æ™°ã€‚ä½ æ‹’ç»èŠ±å“¨çš„æƒ…ç»ªæå†™ï¼Œä¸“æ³¨äºç”¨ä¸“ä¸šçš„è¯æ±‡æè¿°æˆ¿å­çš„ç‰©ç†å±æ€§å’Œå±…ä½ä»·å€¼ã€‚

# Workflow
## Step 1: æ·±åº¦ç»“æ„åˆ†æ
ä»”ç»†è§‚å¯Ÿå›¾ç‰‡ï¼Œæ¨æ–­æˆ¿æºçš„ç‰©ç†å±æ€§ï¼š
* æˆ·å‹ç»“æ„ï¼šåŠ¨é™åˆ†ç¦»ï¼Ÿå—åŒ—é€šé€ï¼Ÿå¨å«å…¨æ˜ï¼Ÿ
* ä¿å…»çŠ¶å†µï¼šé¦–æ¬¡å‡ºç§Ÿï¼Ÿè‡ªä½ä¿å…»ï¼Ÿè€æ—§ä½†æ•´æ´ï¼Ÿ
* é‡‡å…‰ä¸è§†é‡ï¼šæ¥¼å±‚åˆ¤æ–­ã€æ¥¼é—´è·

## Step 2: è¾“å‡ºæ ¼å¼

### 1. æˆ¿æºæ ‡é¢˜
20-30å­—ï¼ŒåŒ…å«æ ¸å¿ƒå…³é”®è¯ï¼ˆå°åŒºå+æˆ·å‹+æ ¸å¿ƒå–ç‚¹ï¼‰
æ ¼å¼ï¼š[æ ¸å¿ƒå–ç‚¹] + [æˆ·å‹] + [ç‹¬ç‰¹ä¼˜åŠ¿]
ç¤ºä¾‹ï¼šç²¾è£…å…¨é…å¤§ä¸¤å±… å—åŒ—é€šé€ é‡‡å…‰å¥½ æ‹åŒ…å…¥ä½ éšæ—¶çœ‹æˆ¿

### 2. æˆ¿æºè¯¦æƒ…
ç»“æ„åŒ–æè¿°ï¼Œå¿…é¡»åŒ…å«ä»¥ä¸‹å­æ ‡é¢˜ï¼š

ã€æ ¸å¿ƒå–ç‚¹ã€‘
ç”¨ä¸€å¥è¯æ€»ç»“ï¼Œä¾‹å¦‚ï¼šæœ¬æˆ¿æºä¸ºæˆ¿ä¸œè‡ªä½è£…ä¿®ï¼Œé¦–æ¬¡å‡ºç§Ÿï¼Œå®¶ç”µå®¶å…·å…¨é…ã€‚

ã€æˆ·å‹ä»‹ç»ã€‘
ç»“åˆå›¾ç‰‡æè¿°å¸ƒå±€ã€‚ä¾‹å¦‚ï¼šè¿›é—¨æ˜¯å®½æ•å®¢å…ï¼Œå§å®¤æœå—å¸¦é£˜çª—ï¼Œå¨æˆ¿å¸¦ç”Ÿæ´»é˜³å°ï¼Œå¹²æ¹¿åˆ†ç¦»å«ç”Ÿé—´ã€‚

ã€è£…ä¿®æè¿°ã€‘
æ ¹æ®å›¾ç‰‡è¯†åˆ«æè´¨ã€‚ä¾‹å¦‚ï¼šå®æœ¨åœ°æ¿ï¼Œå“ç‰Œå«æµ´ï¼ŒåŒå±‚éš”éŸ³ç»ç’ƒã€‚æ•´ä½“é£æ ¼ç®€çº¦ç°ä»£ï¼Œä¿å…»çŠ¶å†µæä½³ã€‚

# Constraints
* ä¸¥ç¦ Emojiï¼šä¿æŒçº¯æ–‡æœ¬ä¸“ä¸šé£æ ¼
* ä¸“ä¸šæœ¯è¯­ï¼šå¤šç”¨"æ˜å¨æ˜å«"ã€"åŠ¨é™åˆ†åŒº"ã€"åˆ©ç”¨ç‡é«˜"ã€"è§†é‡å¼€é˜”"
* æ‹’ç»ç…½æƒ…ï¼šä¸è¦å†™"æ²»æ„ˆ"ã€"ç»ç»å­"ï¼Œè¦å†™"èˆ’é€‚"ã€"å®œå±…"ã€"åŠŸèƒ½é½å…¨"
* åŸºäºäº‹å®ï¼šå¦‚æœå›¾ç‰‡é‡Œæ²¡çœ‹åˆ°æŸè®¾æ–½ï¼Œä¸è¦å‡­ç©ºç¼–é€ `

export async function POST(req: NextRequest) {
    try {
        const { propertyInfo, imageFeatures } = await req.json()

        console.log('=== æ–‡æ¡ˆç”Ÿæˆ API ===')

        const DEEPSEEK_API_KEY = process.env.DEEPSEEK_API_KEY

        if (!DEEPSEEK_API_KEY) {
            return NextResponse.json({ error: 'ç¼ºå°‘APIé…ç½®' }, { status: 500 })
        }

        const baseInfo = `
ã€æˆ¿æºä¿¡æ¯ã€‘
æˆ·å‹ï¼š${propertyInfo.houseType}
é¢ç§¯ï¼š${propertyInfo.area}å¹³ç±³
å°åŒºï¼š${propertyInfo.communityName}
ä»·æ ¼ï¼š${propertyInfo.price}ä¸‡
äº®ç‚¹ï¼š${propertyInfo.highlights.join('ã€') || 'æ— '}
å›¾ç‰‡åˆ†æï¼š${imageFeatures}
`

        // å¹¶è¡Œç”Ÿæˆä¸‰ä¸ªç‰ˆæœ¬
        const [xhsRes, momentsRes, beikeRes] = await Promise.all([
            // å°çº¢ä¹¦ç‰ˆ
            fetch('https://api.deepseek.com/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${DEEPSEEK_API_KEY}`
                },
                body: JSON.stringify({
                    model: 'deepseek-chat',
                    messages: [
                        { role: 'system', content: XIAOHONGSHU_PROMPT },
                        { role: 'user', content: `è¯·ä¸ºä»¥ä¸‹æˆ¿æºç”Ÿæˆå°çº¢ä¹¦æ–‡æ¡ˆï¼š${baseInfo}` }
                    ],
                    stream: false
                })
            }),
            // æœ‹å‹åœˆç‰ˆ
            fetch('https://api.deepseek.com/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${DEEPSEEK_API_KEY}`
                },
                body: JSON.stringify({
                    model: 'deepseek-chat',
                    messages: [
                        { role: 'system', content: MOMENTS_PROMPT },
                        { role: 'user', content: `è¯·ä¸ºä»¥ä¸‹æˆ¿æºç”Ÿæˆå¾®ä¿¡æœ‹å‹åœˆæ–‡æ¡ˆï¼š${baseInfo}` }
                    ],
                    stream: false
                })
            }),
            // è´å£³ç‰ˆ
            fetch('https://api.deepseek.com/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${DEEPSEEK_API_KEY}`
                },
                body: JSON.stringify({
                    model: 'deepseek-chat',
                    messages: [
                        { role: 'system', content: BEIKE_PROMPT },
                        { role: 'user', content: `è¯·ä¸ºä»¥ä¸‹æˆ¿æºç”Ÿæˆè´å£³æ‰¾æˆ¿æ–‡æ¡ˆï¼š${baseInfo}` }
                    ],
                    stream: false
                })
            })
        ])

        const [xhsData, momentsData, beikeData] = await Promise.all([
            xhsRes.json(),
            momentsRes.json(),
            beikeRes.json()
        ])

        // æ¸…ç†Markdownç¬¦å·çš„å‡½æ•°
        const cleanContent = (text: string) => {
            return text
                .replace(/^#{1,6}\s*/gm, '')  // åˆ é™¤æ ‡é¢˜ç¬¦å· ###
                .replace(/\*\*/g, '')          // åˆ é™¤åŠ ç²— **
                .replace(/\*/g, '')            // åˆ é™¤å•ä¸ª *
                .replace(/^-\s+/gm, 'â€¢ ')      // å°† - åˆ—è¡¨æ›¿æ¢ä¸º â€¢
                .trim()
        }

        const xhsContent = cleanContent(xhsData.choices?.[0]?.message?.content || '')
        const momentsContent = cleanContent(momentsData.choices?.[0]?.message?.content || '')
        const beikeContent = cleanContent(beikeData.choices?.[0]?.message?.content || '')

        console.log('âœ… ä¸‰å¹³å°æ–‡æ¡ˆç”ŸæˆæˆåŠŸ')

        // ä»äº®ç‚¹ä¸­æå–å–ç‚¹
        const sellingPoints = [
            'â€¢ ' + (propertyInfo.highlights[0] || 'ä¼˜è´¨æˆ¿æº'),
            'â€¢ ' + (propertyInfo.highlights[1] || 'äº¤é€šä¾¿åˆ©'),
            'â€¢ ' + (propertyInfo.highlights[2] || 'è£…ä¿®ç²¾ç¾'),
            'â€¢ é‡‡å…‰å……è¶³ï¼Œç©ºé—´é€šé€',
            'â€¢ æ‹åŒ…å…¥ä½ï¼Œé…å¥—é½å…¨'
        ]

        return NextResponse.json({
            sellingPoints,
            contents: {
                'è´å£³ç‰ˆ': beikeContent,
                'å°çº¢ä¹¦ç‰ˆ': xhsContent,
                'æœ‹å‹åœˆç‰ˆ': momentsContent
            }
        })

    } catch (error) {
        console.error('Error:', error)
        return NextResponse.json({
            error: 'ç”Ÿæˆå¤±è´¥ï¼š' + (error as Error).message
        }, { status: 500 })
    }
}
